<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSD PRO | Pharma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .card { background: white; border-radius: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .btn-pay { background: linear-gradient(135deg, #6366f1, #4f46e5); color: white; }
        #dispatchBtn { display: none; background: #0f172a; color: white; }
    </style>
</head>
<body class="min-h-screen pt-20 px-6">

    <nav class="fixed top-0 left-0 w-full bg-white/80 backdrop-blur-md p-4 flex justify-between items-center z-50 border-b">
        <span class="font-black text-slate-900 uppercase">MSD <span class="text-indigo-600 font-medium">Pharma</span></span>
        <div id="activeTag" class="text-[10px] font-bold bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full uppercase">...</div>
    </nav>

    <main class="max-w-md mx-auto space-y-6">
        <div class="card p-8 space-y-5">
            <h2 class="text-xl font-black text-slate-800">New Order</h2>
            
            <input type="text" id="pName" oninput="check()" placeholder="Patient Name" class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold">
            <input type="tel" id="pPhone" oninput="check()" maxlength="10" placeholder="WhatsApp Number" class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold">
            
            <div onclick="document.getElementById('files').click()" class="border-2 border-dashed border-slate-200 rounded-2xl py-6 bg-slate-50 text-center cursor-pointer">
                <span id="fileStatus" class="text-[10px] font-black text-slate-400 uppercase tracking-widest">1. Attach Prescription</span>
                <input type="file" id="files" multiple class="hidden" onchange="check()">
            </div>

            <div id="payBox" class="hidden space-y-4">
                <div class="p-6 bg-indigo-50 rounded-2xl text-center border border-indigo-100">
                    <p class="text-[10px] font-black text-indigo-400 uppercase mb-1">Booking Advance</p>
                    <p class="text-2xl font-black text-slate-900 mb-4">₹50</p>
                    <a id="payLink" href="#" class="btn-pay block w-full py-4 rounded-xl font-black text-xs uppercase">Pay via UPI</a>
                </div>

                <div onclick="document.getElementById('proof').click()" class="border-2 border-indigo-200 border-dashed rounded-xl py-4 bg-white text-center cursor-pointer">
                    <span id="proofStatus" class="text-[10px] font-black text-indigo-500 uppercase">2. Upload Screenshot</span>
                    <input type="file" id="proof" class="hidden" onchange="showDispatch()">
                </div>

                <button id="dispatchBtn" onclick="sendToWhatsApp()" class="w-full py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl">Confirm & Dispatch</button>
            </div>
        </div>
    </main>

    <script>
        const CLOUD = "du14a1qmh";
        const PRESET = "msd_live";
        let WA = "919385352585"; 
        let UPI = "9385352585@ybl";
        let NAME = "Admin";

        // --- AUTO-CALL SYNC ---
        (function sync() {
            const p = new URLSearchParams(window.location.search);
            if(p.get('setPartner') && p.get('setUpi')) {
                localStorage.setItem('wa', p.get('setPartner'));
                localStorage.setItem('upi', p.get('setUpi'));
                localStorage.setItem('name', p.get('setName'));
                window.history.replaceState({},'',window.location.pathname);
            }
            WA = localStorage.getItem('wa') || WA;
            UPI = localStorage.getItem('upi') || UPI;
            NAME = localStorage.getItem('name') || NAME;
            
            document.getElementById('activeTag').innerText = "LIVE: " + NAME;
            document.getElementById('payLink').href = `upi://pay?pa=${UPI}&pn=MSD_Pharma&am=50&cu=INR`;
        })();

        function check() {
            const n = document.getElementById('pName').value;
            const p = document.getElementById('pPhone').value;
            const f = document.getElementById('files').files;
            if(f.length > 0) document.getElementById('fileStatus').innerText = `✅ ${f.length} Files Selected`;
            if(n.length > 2 && p.length === 10 && f.length > 0) document.getElementById('payBox').classList.remove('hidden');
        }

        function showDispatch() {
            if(document.getElementById('proof').files.length > 0) {
                document.getElementById('proofStatus').innerText = "✅ Screenshot Ready";
                document.getElementById('dispatchBtn').style.display = 'block';
            }
        }

        async function sendToWhatsApp() {
            const btn = document.getElementById('dispatchBtn');
            btn.innerText = "UPLOADING..."; btn.disabled = true;

            try {
                const presc = [...document.getElementById('files').files];
                const proof = document.getElementById('proof').files[0];
                let links = [];

                for(let f of [proof, ...presc]) {
                    const fd = new FormData();
                    fd.append('file', f); fd.append('upload_preset', PRESET);
                    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD}/image/upload`, {method:'POST', body:fd});
                    const d = await res.json(); links.push(d.secure_url);
                }

                // CLEAN WHATSAPP MESSAGE (No long URL)
                let msg = `*NEW ORDER - MSD PHARMA*%0A`;
                msg += `*Patient:* ${document.getElementById('pName').value}%0A`;
                msg += `*Contact:* ${document.getElementById('pPhone').value}%0A%0A`;
                msg += `*Payment Proof:*%0A${links[0]}%0A%0A`;
                msg += `*Prescriptions:*%0A`;
                links.slice(1).forEach((l, i) => msg += `File ${i+1}: ${l}%0A`);

                window.location.href = `https://wa.me/${WA}?text=${msg}`;
            } catch (e) {
                alert("Error! Check internet.");
                btn.innerText = "Confirm & Dispatch"; btn.disabled = false;
            }
        }
    </script>
</body>
</html>
